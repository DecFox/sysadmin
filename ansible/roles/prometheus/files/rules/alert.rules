ALERT InstanceDown
  IF probe_success == 0
  FOR 5m
  LABELS { severity = "critical" }
  ANNOTATIONS {
    summary = "Instance {{ $labels.instance }} down",
    description = "{{ $labels.instance }} of job \"{{ $labels.job }}\" has been down for more than 1 minute.",
  }

# letsencrypt should renew the cert as soon as there are 30 days till expiration
ALERT SSLCertExpires
  IF (probe_ssl_earliest_cert_expiry - time()) / 86400 < 25
  LABELS { severity = "critical" }
  ANNOTATIONS {
    summary = 'SSL cert for {{ $labels.instance }} expires',
    description = 'SSL cert for {{ $labels.instance }} expires in {{ printf "%.0f" $value }} days',
  }

# NB: node_filesystem_avail is for non-root users, node_filesystem_free is for root. They are equal for XFS.
ALERT DiskWillFillInAWeek
  IF (node_filesystem_avail{fstype=~"(ext[34]|xfs)"} + delta(node_filesystem_avail{fstype=~"(ext[34]|xfs)"}[48h])*3.5) / 1073741824 < 0
  FOR 1h
  LABELS { severity = "critical" }
  ANNOTATIONS {
    summary = "In a week {{ $labels.instance }} becomes full",
    description = 'In a week {{ $labels.instance }} will run out of disk space. Predicted overcommit: {{ printf "%.1f" $value }} GiB',
  }

ALERT DiskSpaceOver80pct
  IF node_filesystem_avail{fstype=~"(ext[34]|xfs)"} / node_filesystem_size{fstype=~"(ext[34]|xfs)"} * 100 < 20
  LABELS { severity = "critical" }
  ANNOTATIONS {
    summary = "Disk usage at {{ $labels.instance }} over 80%",
    description = '{{ printf "%.1f" $value }}% disk space available at {{ $labels.instance }}',
  }

ALERT DiskInodesOver50pct
  IF node_filesystem_files_free{fstype=~"(ext[34]|xfs)"} / node_filesystem_files{fstype=~"(ext[34]|xfs)"} * 100 < 50
  LABELS { severity = "critical" }
  ANNOTATIONS {
    summary = "Inode usage at {{ $labels.instance }} over 50%",
    description = "{{ printf '%.1f' $value }}% inodes free at {{ $labels.instance }}",
  }
