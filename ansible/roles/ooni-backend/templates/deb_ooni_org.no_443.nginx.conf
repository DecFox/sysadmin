# Managed by ansible, see roles/ooni-backend/tasks/main.yml

# anonymize ipaddr
map $remote_addr $remote_addr_anon {
  ~(?P<ip>\d+\.\d+\.\d+)\.    $ip.0;
  ~(?P<ip>[^:]+:[^:]+):       $ip::;
  default                     0.0.0.0;
}

# log anonymized ipaddr
log_format deb_ooni_org_logfmt '$remote_addr_anon [$time_local] '
    '"$request" $status snt:$body_bytes_sent rt:$request_time uprt:$upstream_response_time "$http_referer" "$http_user_agent"';

server {
  listen 80;
  server_name deb.ooni.org;
  access_log syslog:server=unix:/dev/log,severity=info deb_ooni_org_logfmt;
  error_log syslog:server=unix:/dev/log,severity=info;
  gzip on;
  resolver 127.0.0.1;
  # Serve ACME challenge from disk
  location ^~ /.well-known/acme-challenge {
    alias /var/lib/dehydrated/acme-challenges;
  }
  location / {
    proxy_pass https://ooni-deb.s3.eu-central-1.amazonaws.com/;
  }
}
